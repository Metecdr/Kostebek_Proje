{% extends 'base.html' %}
{% load static %}

{% block title %}Bul Bakalım - Soru {{ soru_no }}/{{ toplam_soru }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- ÜST BAR: İLERLEME VE SÜRE -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-2">🎯 Bul Bakalım</h5>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ soru_no|floatformat:0|add:0 }}0%;" 
                             aria-valuenow="{{ soru_no }}" aria-valuemin="0" aria-valuemax="5">
                            Soru {{ soru_no }} / {{ toplam_soru }}
                        </div>
                    </div>
                </div>
                <div class="col-md-3 text-center">
                    <h6 class="mb-1">⏱️ Kalan Süre</h6>
                    <h2 id="timer" class="text-danger mb-0">90</h2>
                </div>
                <div class="col-md-3 text-center">
                    <h6 class="mb-1">📊 Skor</h6>
                    <h4 class="mb-0">
                        <span class="text-success">✅ {{ oyun.dogru_sayisi }}</span> / 
                        <span class="text-danger">❌ {{ oyun.yanlis_sayisi }}</span>
                    </h4>
                </div>
            </div>
        </div>
    </div>

    <!-- SORU KARTI -->
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">📝 Soru {{ soru_no }}</h4>
        </div>
        <div class="card-body p-4">
            <!-- SORU METNİ -->
            <div class="alert alert-light border" style="font-size: 1.1rem; line-height: 1.8;">
                {{ aktif_soru.metin }}
            </div>

            <!-- CEVAP ŞIKLARı -->
            <div class="mt-4">
                <h5 class="mb-3">Cevapları seçin:</h5>
                {% for cevap in cevaplar %}
                <div class="d-grid gap-2 mb-3">
                    <button class="btn btn-outline-primary btn-lg text-start cevap-btn" 
                            data-cevap-id="{{ cevap.id }}"
                            style="padding: 15px 20px; font-size: 1.1rem;">
                        <strong>{{ forloop.counter|upper }})</strong> {{ cevap.metin }}
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- BİLGİ -->
    <div class="alert alert-info mt-4">
        <strong>💡 İpucu:</strong> 3 veya daha fazla doğru cevap verirseniz 1 puan kazanırsınız!
    </div>
</div>

<!-- CEVAP SONUÇ MODAL -->
<div class="modal fade" id="cevapModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div id="dogru-sonuc" style="display: none;">
                    <div class="display-1 text-success">✅</div>
                    <h3 class="text-success mt-3">DOĞRU!</h3>
                    <p class="lead">Tebrikler! Doğru cevap verdiniz!</p>
                </div>
                <div id="yanlis-sonuc" style="display: none;">
                    <div class="display-1 text-danger">❌</div>
                    <h3 class="text-danger mt-3">YANLIŞ!</h3>
                    <p class="lead">Üzgünüz, yanlış cevap...</p>
                </div>
                <button type="button" class="btn btn-primary btn-lg mt-3" id="devam-btn">
                    Sonraki Soru →
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.cevap-btn {
    transition: all 0.3s ease;
}
.cevap-btn:hover {
    transform: translateX(10px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.cevap-btn:disabled {
    cursor: not-allowed;
}
</style>

<script>
if (typeof bootstrap === 'undefined') {
    console.log('Bootstrap yükleniyor...');
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js';
    document.head.appendChild(script);
}
</script>

<script>
// CSRF TOKEN AL
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Sayfa yüklendiğinde çalışsın
document.addEventListener('DOMContentLoaded', function() {
    
    // SÜRE SAYACI
    let kalanSure = {{ sure }};
    const timerElement = document.getElementById('timer');

    const interval = setInterval(() => {
        kalanSure--;
        timerElement.textContent = kalanSure;
        
        if (kalanSure <= 10) {
            timerElement.classList.add('text-danger');
            timerElement.style.fontWeight = 'bold';
        }
        
        if (kalanSure <= 0) {
            clearInterval(interval);
            // Süre bittiğinde modal göster
            showSonucModal(false, 'Süre bitti! ⏰');
            
            // Cevap otomatik gönder (cevapsız/yanlış kaydet)
            // Backend'de cevap yoksa yanlış sayılacak şekilde düzenlenmiş olmalı!
            fetch('{% url "bul_bakalim_cevapla" oyun.oyun_id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ cevap_id: null }) // null gönder, backend'e göre yanlış sayılır
            })
            .then(response => response.json())
            .then(data => {
                setTimeout(() => {
                    if (data.oyun_bitti) {
                        window.location.href = data.redirect_url;
                    } else {
                        window.location.reload();
                    }
                }, 2000);
            });
        }
    }, 1000);

    // CEVAP GÖNDERME
    const cevapButtons = document.querySelectorAll('.cevap-btn');

    cevapButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const cevapId = this.dataset.cevapId;
            
            // Tüm butonları devre dışı bırak
            cevapButtons.forEach(b => {
                b.disabled = true;
                b.style.opacity = '0.5';
            });
            
            // Tıklanan butonu vurgula
            this.style.transform = 'scale(1.05)';
            this.style.boxShadow = '0 0 20px rgba(0,123,255,0.5)';
            
            // Süreyi durdur
            clearInterval(interval);
            
            // Cevabı gönder
            fetch('{% url "bul_bakalim_cevapla" oyun.oyun_id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ cevap_id: cevapId })
            })
            .then(response => response.json())
            .then(data => {
                showSonucModal(data.dogru_mu);
                setTimeout(() => {
                    if (data.oyun_bitti) {
                        window.location.href = data.redirect_url;
                    } else {
                        window.location.reload();
                    }
                }, 2000);
            })
            .catch(error => {
                alert('Bir hata oluştu: ' + error);
                cevapButtons.forEach(b => {
                    b.disabled = false;
                    b.style.opacity = '1';
                });
            });
        });
    });
});

// GÜZEL SONUÇ MODALI
function showSonucModal(dogruMu, mesaj = '') {
    // Mevcut modal'ı kaldır
    const mevcutModal = document.getElementById('dinamikModal');
    if (mevcutModal) {
        mevcutModal.remove();
    }
    
    // Yeni modal oluştur
    const modalHTML = `
        <div class="modal fade" id="dinamikModal" tabindex="-1" style="z-index: 9999;">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-body text-center p-5" style="background: ${dogruMu ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)'}; color: white; border-radius: 15px;">
                        <div style="font-size: 100px; animation: bounceIn 0.6s;">
                            ${dogruMu ? '✅' : '❌'}
                        </div>
                        <h2 class="mt-3 mb-2" style="font-weight: bold; font-size: 2.5rem;">
                            ${dogruMu ? 'DOĞRU!' : 'YANLIŞ!'}
                        </h2>
                        <p class="lead mb-0" style="font-size: 1.3rem;">
                            ${mesaj || (dogruMu ? 'Tebrikler! Harika gidiyorsun! 🎉' : 'Üzülme, bir sonraki sefere! 💪')}
                        </p>
                        <div class="mt-4">
                            <div class="spinner-border text-light" role="status">
                                <span class="visually-hidden">Yükleniyor...</span>
                            </div>
                            <p class="mt-2 mb-0" style="font-size: 0.9rem;">Sonraki soruya geçiliyor...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modal = new bootstrap.Modal(document.getElementById('dinamikModal'));
    modal.show();
}
</script>

<style>
@keyframes bounceIn {
    0% {
        opacity: 0;
        transform: scale(0.3);
    }
    50% {
        opacity: 1;
        transform: scale(1.1);
    }
    100% {
        transform: scale(1);
    }
}

.cevap-btn {
    transition: all 0.3s ease;
    border: 2px solid #0d6efd;
}

.cevap-btn:hover {
    transform: translateX(10px);
    box-shadow: 0 4px 15px rgba(13, 110, 253, 0.3);
    background-color: #0d6efd;
    color: white;
}
</style>
{% endblock %}