{% extends 'base.html' %}
{% load static %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
<style>
body {
    background: #9e7bfa;
    font-family: 'Montserrat', 'Nunito', sans-serif;
    min-height: 100vh;
}
.tabu-header {
    max-width: 1200px;
    margin: 48px auto 0 auto;
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 0;
}
.tabu-header-logo {
    height: 44px;
    width: auto;
    margin-right: 14px;
}
.tabu-header-title {
    font-size: 2.2rem;
    font-weight: 900;
    color: #fff;
    letter-spacing: 1px;
    margin-bottom: 0;
    margin-right: 10px;
}
.tabu-header-sure {
    margin-left: auto;
    padding: 11px 20px;
    background: #6a4adf;
    color: #fff;
    border-radius: 32px;
    font-size: 1.15rem;
    font-weight: 700;
    box-shadow: 0 2px 16px #7B68EE22;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.tabu-main { max-width: 1200px; margin: 0 auto; display: flex; flex-direction: row; gap: 38px; padding-bottom: 48px; margin-top: 28px;}
.tabu-left { width: 320px; display: flex; flex-direction: column; align-items: center; gap: 28px;}
.tabu-kelime-box { width: 100%; background: #fff; border-radius: 25px; box-shadow: 0 4px 18px #7B68EE22; padding: 28px 0 8px 0; display: flex; flex-direction: column; align-items: center;}
.tabu-kelime-title { font-size: 1.13rem; font-weight: 800; color: #6a4adf; margin-bottom: 11px; letter-spacing: 0.5px;}
.tabu-kelime { font-size: 2.4rem; font-weight: 900; color: #222; letter-spacing: 1.2px; margin-bottom: 10px; margin-top: 7px;}
.tabu-yasakli-box { width: 100%; background: #fff; border-radius: 25px; box-shadow: 0 4px 18px #7B68EE22; padding: 25px 24px 25px 24px; min-height: 120px; display: flex; flex-direction: column; align-items: left;}
.tabu-yasakli-title { font-size: 1.10rem; font-weight: 800; color: #6a4adf; margin-bottom: 11px; letter-spacing: 0.5px;}
.tabu-yasakli-list { padding: 0; margin: 0; list-style: disc inside;}
.tabu-yasakli-list li { font-size: 1.25rem; font-weight: 700; color: #333; margin-bottom: 6px; margin-left: 10px;}
.tabu-center { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 20px; justify-content: center;}
.tabu-title { font-size: 3rem; font-weight: 900; color: #fff; letter-spacing: 2px; margin-bottom: 14px; text-align: center; text-shadow: 0 3px 20px #6a4adf44;}
.tabu-tahmin-box { background: #fff; border-radius: 30px; box-shadow: 0 8px 38px #7B68EE22; min-height: 180px; width: 99%; max-width: 440px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 32px 30px 26px 30px;}
.tabu-tahmin-title { font-size: 1.15rem; font-weight: 800; color: #6a4adf; margin-bottom: 18px; text-align: center;}
.tabu-tahmin-metin { font-size: 2.5rem; font-weight: 900; color: #222; letter-spacing: 1px; margin-bottom: 0;}
.tabu-buttons { display: flex; gap: 18px; margin-top: 28px;}
.tabu-btn { background: linear-gradient(90deg,#f7d168,#e3c9f7); color: #222; font-weight: 800; font-size: 1.11rem; padding: 14px 38px; border: none; border-radius: 55px; box-shadow: 0 2px 18px #7B68EE22; cursor: pointer; transition: all .15s;}
.tabu-btn.tabu { background: linear-gradient(90deg,#ec6f7b,#b399e6); color: #fff; }
.tabu-btn.dogru { background: linear-gradient(90deg,#7ba7ee,#b399e6); color: #fff; }
.tabu-btn.pas { background: linear-gradient(90deg,#f7e168,#b399e6); color: #333; }
.tabu-btn:hover { transform: scale(1.07); box-shadow: 0 8px 30px #6a4adf33;}
.tabu-right { width: 240px; display: flex; flex-direction: column; gap: 22px; justify-content: flex-start;}
.tabu-score-box { width: 100%; background: #6a4adf; border-radius: 25px; box-shadow: 0 4px 18px #7B68EE22; padding: 28px 18px 22px 18px; min-height: 90px; display: flex; flex-direction: column; align-items: center; color: #fff;}
.tabu-score-title { font-size: 1.15rem; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px;}
.tabu-score-value { font-size: 2.2rem; font-weight: 900; margin-bottom: 0; letter-spacing: 1px;}
.tabu-araekran { max-width: 600px; margin: 60px auto 0 auto; background: #fff; border-radius: 28px; box-shadow: 0 8px 38px #7B68EE22; padding: 48px 42px; text-align: center;}
.tabu-araekran-title { font-size: 2.1rem; font-weight: 900; color: #7B68EE; margin-bottom: 24px; }
.tabu-araekran-text { font-size: 1.7rem; font-weight: 800; color: #6a4adf; margin-bottom: 18px; }
.tabu-araekran-btn { margin-top: 18px; padding: 14px 38px; font-size: 1.3rem; font-weight: 800; border-radius: 55px; background: linear-gradient(90deg,#7ba7ee,#b399e6); color: #fff; border: none; cursor: pointer; box-shadow: 0 2px 18px #7B68EE22; transition: all .13s;}
.tabu-araekran-btn:hover { background: linear-gradient(90deg,#49df7b,#7B68EE); color: #fff; transform: scale(1.07);}
@media (max-width: 1050px) { .tabu-header, .tabu-main { flex-direction: column; align-items: center; } .tabu-left, .tabu-right { width: 85vw; } .tabu-center { width: 85vw; } .tabu-tahmin-box { max-width: 100vw; } }
@media (max-width: 600px) { .tabu-header, .tabu-main { flex-direction: column; gap: 12px;} .tabu-left, .tabu-right { width: 98vw; } .tabu-center { width: 98vw; } .tabu-tahmin-box { padding: 20px 8px;} .tabu-header-title { font-size: 1.18rem;} .tabu-title { font-size: 2.1rem;} }
</style>

<div class="tabu-header">
    <img src="{% static 'kostebek_sol_png.png' %}" alt="Köstebek Logo" class="tabu-header-logo" />
    <span class="tabu-header-title">Köstebek</span>
    <div class="tabu-header-sure">
        Süre: <span id="zaman">{{ SURE }}</span>s
        <span style="margin-left:12px;font-size:1rem;color:#fff;font-weight:800;">
            Soru: <span id="soruSayisi">1</span>/{{ MAX_KELIME }}
        </span>
    </div>
</div>

{% if ara_ekran %}
<div class="tabu-araekran">
    <div class="tabu-araekran-title">Sıradaki Tur</div>
    <div class="tabu-araekran-text">Sıra <b>{{ takim_adi }}</b> takımında!</div>
    <div class="tabu-araekran-text" style="font-size:1.2rem;color:#333;">
        60 saniyede <b>{{ MAX_KELIME }} kelime</b> çözmeye çalışın!
    </div>
    <button class="tabu-araekran-btn" onclick="baslatTur()">Turu Başlat!</button>
</div>
{% else %}
<div class="tabu-main">
    <!-- SOL KUTU -->
    <div class="tabu-left">
        <div class="tabu-kelime-box">
            <div class="tabu-kelime-title">Kelime</div>
            <div class="tabu-kelime">{{ kelime.kelime }}</div>
        </div>
        <div class="tabu-yasakli-box">
            <div class="tabu-yasakli-title">Yasaklı Kelimeler</div>
            <ul class="tabu-yasakli-list">
                {% for yasakli in yasaklilar|slice:":5" %}
                    <li>{{ yasakli.yasakli_kelime }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <!-- ORTA KUTU -->
    <div class="tabu-center">
        <div class="tabu-title">TABU</div>
        <div class="tabu-tahmin-box">
            <div class="tabu-tahmin-title">Tahminler</div>
            <div class="tabu-tahmin-metin" id="ana-kelime">{{ kelime.kelime }}</div>
            <div class="tabu-buttons">
                <button onclick="turGuncelle('dogru')" class="tabu-btn dogru">DOĞRU</button>
                <button onclick="turGuncelle('pas')" class="tabu-btn pas">PAS</button>
                <button onclick="turGuncelle('tabu')" class="tabu-btn tabu">TABU</button>
            </div>
        </div>
    </div>
    <!-- SAĞ KUTU -->
    <div class="tabu-right">
        <div class="tabu-score-box">
            <div class="tabu-score-title">{{ oyun.takim_a_adi }}</div>
            <div class="tabu-score-value" id="takim-a-skor">{{ oyun.takim_a_skor }}</div>
        </div>
        <div class="tabu-score-box">
            <div class="tabu-score-title">{{ oyun.takim_b_adi }}</div>
            <div class="tabu-score-value" id="takim-b-skor">{{ oyun.takim_b_skor }}</div>
        </div>
    </div>
</div>
{% endif %}

<script>
const MAX_KELIME = {{ MAX_KELIME }};
const SURE = {{ SURE }};
let saniye = SURE;
let sayac = null;
let kelimeSayisi = 1;
let turAktif = false;

function baslatTur() {
    // Ara ekranı POST ile kapat, sayfa yeniden yüklenir
    fetch(window.location.pathname, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    }).then(() => window.location.reload());
}

{% if ara_ekran %}
document.addEventListener('DOMContentLoaded', () => { turAktif = false; });
{% else %}
// Oyun ekranı aktifse sayaç başlat
function zamanlayici() {
    saniye--;
    document.getElementById('zaman').innerText = saniye;
    if (saniye <= 0) {
        clearInterval(sayac);
        turuBitir();
    }
}
function turuBaslat() {
    saniye = SURE;
    kelimeSayisi = 1;
    document.getElementById('zaman').innerText = saniye;
    document.getElementById('soruSayisi').innerText = kelimeSayisi;
    if (sayac) clearInterval(sayac);
    turAktif = true;
    sayac = setInterval(zamanlayici, 1000);
}
function turGuncelle(action) {
    if (!turAktif) return;
    fetch("{% url 'tabu_tur_guncelle' oyun.id %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ action: action, mevcut_kelime_id: {{ kelime.id }} })
    })
    .then(response => response.json())
    .then(data => {
        if (data.tur_bitti_kelime_yok) {
            turuBitir();
        } else {
            kelimeSayisi++;
            // Soru göstergesini asla MAX_KELIME'den büyük gösterme!
            let gosterilecekSoru = kelimeSayisi;
            if (gosterilecekSoru > MAX_KELIME) gosterilecekSoru = MAX_KELIME;
            document.getElementById('soruSayisi').innerText = gosterilecekSoru;
            document.getElementById('ana-kelime').innerText = data.kelime;
            document.querySelector('.tabu-kelime').innerText = data.kelime;
            document.getElementById('takim-a-skor').innerText = data.takim_a_skor;
            document.getElementById('takim-b-skor').innerText = data.takim_b_skor;
            if (data.yasaklilar) {
                let yasakliList = "";
                data.yasaklilar.slice(0,5).forEach(function(yasakli) {
                    yasakliList += "<li>" + yasakli + "</li>";
                });
                var yasakliUl = document.querySelector('.tabu-yasakli-list');
                if (yasakliUl) yasakliUl.innerHTML = yasakliList;
            }
            if (kelimeSayisi >= MAX_KELIME) {
                setTimeout(turuBitir, 400);
            }
        }
    });
}
function turuBitir() {
    turAktif = false;
    clearInterval(sayac);
    kelimeSayisi = 1;
    fetch("{% url 'tabu_tur_degistir' oyun.id %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}' }
    })
    .then(response => response.json())
    .then(data => {
        window.location.href = data.redirect_url;
    });
}
window.onload = turuBaslat;
{% endif %}
</script>
{% endblock %}